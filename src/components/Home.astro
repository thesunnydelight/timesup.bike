---
import home from '../content/home.json';

const emailPattern = /[\w.+-]+@[\w.-]+\.[A-Za-z]{2,}/g;
const supportUrl = 'https://times-up.org/support/';
const keywordLinks = [
	{
		text: 'Membership Page',
		href: supportUrl,
		attrs: { rel: 'noreferrer noopener', target: '_blank' },
	},
];

const linkifyText = (text) => {
	const segments = [];
	let cursor = 0;

	const getNextMatch = (start) => {
		let nextMatch = { index: Infinity };

		emailPattern.lastIndex = start;
		const emailMatch = emailPattern.exec(text);
		if (emailMatch) {
			nextMatch = {
				type: 'email',
				value: emailMatch[0],
				index: emailMatch.index,
				length: emailMatch[0].length,
			};
		}

		const keywordMatch = keywordLinks
			.map((item) => ({
				type: 'link',
				value: item.text,
				href: item.href,
				attrs: item.attrs,
				index: text.indexOf(item.text, start),
				length: item.text.length,
			}))
			.filter((item) => item.index !== -1)
			.sort((a, b) => a.index - b.index)[0];

		if (keywordMatch && keywordMatch.index < nextMatch.index) {
			return keywordMatch;
		}

		return nextMatch.index !== Infinity ? nextMatch : null;
	};

	while (cursor < text.length) {
		const match = getNextMatch(cursor);

		if (!match) {
			segments.push({ type: 'text', value: text.slice(cursor) });
			break;
		}

		if (match.index > cursor) {
			segments.push({ type: 'text', value: text.slice(cursor, match.index) });
		}

		segments.push(match);
		cursor = match.index + match.length;
	}

	emailPattern.lastIndex = 0;
	return segments;
};

const { hero, schedule, overview, location, join, contact } = home;
---

<section id="home" class="home">
	<div class="home-hero">
		<h1>{hero.title}</h1>
		{hero.paragraphs.map((text) => (
			<p>{text}</p>
		))}
	</div>

	<div class="info-grid">
		<section id="overview" class="info-card">
			<h2>{overview.heading}</h2>
			{overview.paragraphs.map((text) => (
				<p>{text}</p>
			))}
			<img class="overview-hero" src={overview.image.src} alt={overview.image.alt} />
		</section>

		<section id="schedule" class="info-card">
			<h2>Schedule Overview</h2>
			<dl class="schedule-list">
				{schedule.map((item) => (
					<div class="schedule-item">
						<dt>{item.label}</dt>
						<dd>{item.detail}</dd>
					</div>
				))}
			</dl>
		</section>

		<section id="location" class="info-card">
			<h2>{location.heading}</h2>
			<img class="location-map" src={location.mapImage.src} alt={location.mapImage.alt} />
			<address>
				<a
					class="location-link"
					href="https://maps.app.goo.gl/yY5xKLyQZChtnrhP6"
					target="_blank"
					rel="noreferrer noopener"
				>
					{location.address.map((line, index) => (
						<>
							{line}
							{index < location.address.length - 1 && <br />}
						</>
					))}
				</a>
			</address>
			{location.paragraphs.map((text) => (
				<p>{text}</p>
			))}
		</section>

		<section id="join" class="info-card">
			<h2>{join.heading}</h2>
			{join.paragraphs.map((text) => (
				<p>
					{linkifyText(text).map((segment) => {
						if (segment.type === 'email') {
							return <a href={`mailto:${segment.value}`}>{segment.value}</a>;
						}

						if (segment.type === 'link') {
							return (
								<a href={segment.href} rel={segment.attrs?.rel} target={segment.attrs?.target}>
									{segment.value}
								</a>
							);
						}

						return segment.value;
					})}
				</p>
			))}
		</section>

		<section id="contact" class="info-card contact-card">
			<h2>{contact.heading}</h2>
			<p>{contact.intro}</p>
			<p class="contact-email">
				<a href={`mailto:${contact.email}`}>{contact.email}</a>
			</p>
		</section>
	</div>
</section>

<style>
	.home {
		padding: 96px 16px 120px;
		background: var(--site-gradient);
	}

	.home-hero {
		max-width: 900px;
		margin: 0 auto 56px;
		text-align: center;
		color: #0f172a;
	}

	.home-hero h1 {
		font-size: 44px;
		margin: 0 0 16px;
		line-height: 1.1;
	}

	.home-hero p {
		margin: 0 auto;
		max-width: 640px;
		font-size: 18px;
		line-height: 1.7;
		color: #1f2937;
	}

	.home-hero p + p {
		margin-top: 16px;
	}

	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(min(520px, 100%), 1fr));
		gap: 28px;
		max-width: 1100px;
		margin: 0 auto;
	}

	.info-card {
		background: rgba(255, 255, 255, 0.95);
		border-radius: 18px;
		padding: 28px 32px;
		box-shadow: 0 18px 38px rgba(15, 23, 42, 0.12);
		border: 1px solid rgba(15, 23, 42, 0.08);
		display: flex;
		flex-direction: column;
		gap: 16px;
		color: #1f2937;
	}

	.info-card h2 {
		margin: 0;
		font-size: 24px;
		color: #0f172a;
	}

	.info-card p {
		margin: 0;
		line-height: 1.65;
	}

	.info-card p + p {
		margin-top: 12px;
	}

	.overview-hero {
		width: 100%;
		margin: 8px 0 16px;
		border-radius: 12px;
		border: 1px solid rgba(15, 23, 42, 0.08);
		box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
		object-fit: cover;
		max-height: 540px;
	}

	.location-map {
		width: 100%;
		margin: 8px 0 12px;
		border-radius: 12px;
		border: 1px solid rgba(15, 23, 42, 0.08);
		box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
	}

	.schedule-list {
		margin: 0;
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.schedule-item {
		display: grid;
		gap: 4px;
	}

	.schedule-item dt {
		font-weight: 600;
		color: #111827;
	}

	.schedule-item dd {
		margin: 0;
		color: #4b5563;
		line-height: 1.65;
	}

	address {
		font-style: normal;
		color: #1f2937;
		line-height: 1.6;
	}

	.location-link {
		color: inherit;
		text-decoration: none;
	}

	.location-link:hover,
	.location-link:focus {
		text-decoration: underline;
	}

	.contact-card .contact-email {
		font-weight: 600;
		font-size: 18px;
	}

	.contact-card a {
		color: #2563eb;
		text-decoration: none;
	}

	.contact-card a:hover,
	.contact-card a:focus {
		text-decoration: underline;
	}

	@media screen and (max-width: 768px) {
		.home {
			padding: 64px 16px 96px;
		}

		.home-hero h1 {
			font-size: 36px;
		}

		.info-card {
			padding: 24px;
		}
	}
</style>
